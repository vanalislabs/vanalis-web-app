# PLAN_000002: Migrasi SubmitDataPage dari Commit-Reveal ke Preview-First System

## Deskripsi Singkat

Mengubah sistem submission di `SubmitDataPage.tsx` dari commit-reveal process menjadi preview-first system sesuai dengan product brief. Perubahan ini mencakup:

1. **Upload 2 file terpisah:** Preview Dataset (sample data) dan Full Dataset (data lengkap)
2. **Preview-first flow:** Preview dataset langsung accessible untuk curator review, full dataset locked sampai approve
3. **UI update:** Mengganti penjelasan commit-reveal dengan preview-first system
4. **Form validation:** Memastikan kedua file sudah diupload sebelum submit

Sesuai dengan product brief, **Preview dataset = Sample Data** (sebagian data representatif dari full dataset, bukan thumbnail atau compressed version).

## File dan Fungsi yang Perlu Diubah/Dibuat

### File yang Perlu Diubah:

1. **`src/pages/SubmitDataPage.tsx`**
   - Update state management: ganti `selectedFile` menjadi `previewFile` dan `fullFile` terpisah
   - Update file upload UI: ganti single file upload menjadi 2 file upload terpisah dengan drag-drop area masing-masing
   - Update form validation: tambahkan validasi untuk memastikan kedua file sudah diupload
   - Update UI explanation: ganti card "Commit-Reveal Process" menjadi "Preview-First System" dengan penjelasan yang sesuai
   - Update submit handler: implementasi upload 2 file ke storage (preview accessible, full locked) dan create submission dengan metadata

## Algoritma dan Langkah-Langkah Implementasi

### 1. State Management Update

**Current State:**
```typescript
const [selectedFile, setSelectedFile] = useState<File | null>(null);
```

**New State:**
```typescript
const [previewFile, setPreviewFile] = useState<File | null>(null);
const [fullFile, setFullFile] = useState<File | null>(null);
const [uploadingPreview, setUploadingPreview] = useState(false);
const [uploadingFull, setUploadingFull] = useState(false);
const [previewProgress, setPreviewProgress] = useState(0);
const [fullProgress, setFullProgress] = useState(0);
```

### 2. File Upload UI Update

**Current UI:**
- Single file upload dengan satu drag-drop area
- Satu input file untuk "Data File"

**New UI:**
- **Preview Dataset Upload Section:**
  - Label: "Preview Dataset *" dengan penjelasan: "Sample data representatif dari full dataset untuk review curator"
  - Drag-drop area untuk preview file
  - Display preview file info (name, size) setelah upload
  - Helper text: "Preview harus representatif dan menunjukkan kualitas yang sama dengan full dataset"

- **Full Dataset Upload Section:**
  - Label: "Full Dataset *" dengan penjelasan: "Data lengkap yang akan locked sampai curator approve"
  - Drag-drop area untuk full file
  - Display full file info (name, size) setelah upload
  - Helper text: "Full dataset akan di-lock di storage sampai submission di-approve oleh curator"

### 3. Form Validation

**Validation Rules:**
- Preview file: Required, harus diupload sebelum submit
- Full file: Required, harus diupload sebelum submit
- Title: Required
- Description: Required
- Tags: Optional

**Submit Button State:**
- Disabled jika: `!previewFile || !fullFile || uploadingPreview || uploadingFull`
- Enabled jika: kedua file sudah diupload dan tidak sedang uploading

### 4. UI Explanation Update

**Current Card: "Commit-Reveal Process"**
- Step 1: Hash Generation
- Step 2: Upload & Verify
- Step 3: Curator Review

**New Card: "Preview-First System"**
- **Step 1: Upload Preview Dataset**
  - Upload sample data representatif untuk review curator
  - Preview dataset langsung accessible untuk curator
- **Step 2: Upload Full Dataset**
  - Upload data lengkap yang akan di-lock di storage
  - Full dataset tetap locked sampai curator approve
- **Step 3: Submit & Review**
  - Curator review preview dataset untuk verifikasi kualitas
  - Jika approve → full dataset dibuka → reward distributed
  - Jika reject → submission ditolak (full dataset tetap locked)

**Additional Information:**
- Penjelasan bahwa preview dataset = sample data (bukan thumbnail/compressed)
- Contoh: "Jika full dataset berisi 1000 gambar, preview bisa berisi 50-100 sample gambar yang representatif"

### 5. Submit Handler Update

**Current Flow:**
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setUploading(true);
  // Mock upload progress
  // Navigate to /my-submissions
};
```

**New Flow:**
```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  
  // Validation
  if (!previewFile || !fullFile) {
    // Show error message
    return;
  }
  
  // Get form values
  const title = (document.getElementById('title') as HTMLInputElement)?.value;
  const description = (document.getElementById('description') as HTMLTextAreaElement)?.value;
  const tags = (document.getElementById('tags') as HTMLInputElement)?.value;
  
  try {
    // Step 1: Upload preview dataset (accessible immediately)
    // TODO: Replace with real Walrus SDK upload
    setUploadingPreview(true);
    setPreviewProgress(0);
    // Mock upload with progress simulation
    const previewUrl = await mockUploadToStorage(previewFile, { accessible: true }, (progress) => {
      setPreviewProgress(progress);
    });
    setUploadingPreview(false);
    
    // Step 2: Upload full dataset (locked until approve)
    // TODO: Replace with real Walrus SDK upload
    setUploadingFull(true);
    setFullProgress(0);
    // Mock upload with progress simulation
    const fullUrl = await mockUploadToStorage(fullFile, { accessible: false, locked: true }, (progress) => {
      setFullProgress(progress);
    });
    setUploadingFull(false);
    
    // Step 3: Create submission with metadata
    const submission = {
      projectId,
      title,
      description,
      tags: tags ? tags.split(',').map(t => t.trim()) : [],
      previewDatasetUrl: previewUrl,
      fullDatasetUrl: fullUrl,
      previewDatasetSize: formatFileSize(previewFile.size),
      fullDatasetSize: formatFileSize(fullFile.size),
      status: 'pending' as const,
    };
    
    // TODO: Replace with real API call to POST /api/submissions
    // Mock create submission - hanya log data dan simulate delay
    await mockCreateSubmission(submission);
    
    // Navigate to my-submissions
    navigate("/my-submissions");
  } catch (error) {
    // Handle error
    console.error("Submission failed:", error);
    // TODO: Show user-friendly error message
  }
};

// Mock functions (akan diganti dengan real implementation nanti)
async function mockUploadToStorage(
  file: File, 
  options: { accessible: boolean; locked?: boolean },
  onProgress?: (progress: number) => void
): Promise<string> {
  // Simulate upload progress
  for (let i = 0; i <= 100; i += 10) {
    await new Promise(resolve => setTimeout(resolve, 100));
    onProgress?.(i);
  }
  // Return mock URL
  return `https://walrus-storage.example.com/datasets/${Date.now()}-${file.name}`;
}

async function mockCreateSubmission(submission: any): Promise<void> {
  // Simulate API call delay
  await new Promise(resolve => setTimeout(resolve, 500));
  // Log submission data (akan diganti dengan real API call)
  console.log("Creating submission:", submission);
}
```

**Note:** 
- **Semua upload dan API calls menggunakan MOCK functions** untuk sekarang, karena backend API dan Walrus storage integration belum tersedia.
- `mockUploadToStorage`: Simulate upload progress dan return mock URL
- `mockCreateSubmission`: Simulate API call dan log data
- Struktur sudah siap untuk diintegrasikan dengan real API/storage nanti (tinggal ganti mock functions dengan real implementation)

### 6. Form Fields Connection

**Current:**
- Form fields tidak terhubung dengan state (menggunakan uncontrolled inputs)

**Update:**
- Option 1: Keep uncontrolled inputs (current approach) - cukup ambil value saat submit
- Option 2: Convert to controlled inputs dengan state management
- **Rekomendasi:** Keep uncontrolled untuk sekarang (lebih simple), bisa diubah ke controlled jika perlu form validation real-time

### 7. Progress Tracking

**Current:**
- Single progress bar untuk upload

**New:**
- **Preview Upload Progress:**
  - Progress bar untuk preview dataset upload
  - Show percentage dan status
- **Full Upload Progress:**
  - Progress bar untuk full dataset upload
  - Show percentage dan status
- **Overall Status:**
  - Show current step (Uploading preview... / Uploading full... / Creating submission...)

## Integration Points (Future)

**Catatan:** Saat ini implementasi menggunakan **mock functions** untuk upload dan API calls. Backend API dan storage integration belum tersedia.

### Storage Integration (Future):
- **Preview Dataset:** Upload ke Walrus storage dengan flag `accessible: true` (langsung accessible untuk curator)
- **Full Dataset:** Upload ke Walrus storage dengan flag `accessible: false, locked: true` (locked sampai approve)
- **Storage SDK:** Menggunakan Walrus SDK untuk upload files
- **Saat ini:** Mock upload functions yang return mock URLs

### Backend API Integration (Future):
- **Create Submission Endpoint:** `POST /api/submissions`
  - Request body: `{ projectId, title, description, tags, previewDatasetUrl, fullDatasetUrl, previewDatasetSize, fullDatasetSize }`
  - Response: `{ id, status: 'pending', ... }`
- **Saat ini:** Mock `createSubmission` function yang hanya log data

### Blockchain Integration (Future):
- Submission creation bisa trigger on-chain event (optional)
- **Saat ini:** Tidak ada blockchain integration untuk submission creation

## UI/UX Considerations

### Design Consistency:
- Mengikuti design system yang sudah ada (TailwindCSS, shadcn/ui components)
- Drag-drop areas menggunakan style yang sama dengan current implementation
- Progress bars menggunakan component `Progress` dari shadcn/ui

### User Feedback:
- Clear error messages jika file belum diupload
- Progress indicators untuk setiap upload step
- Success message setelah submission berhasil
- Loading states untuk submit button

### Responsive Design:
- File upload sections stack di mobile
- Drag-drop areas responsive untuk touch devices
- Form layout responsive

## Checklist

- [x] Update state management: Ganti `selectedFile` menjadi `previewFile` dan `fullFile` terpisah, tambahkan state untuk upload progress masing-masing
- [x] Update file upload UI: Buat 2 file upload sections terpisah (Preview Dataset dan Full Dataset) dengan drag-drop area masing-masing
- [x] Update file handlers: Buat `handlePreviewFileChange` dan `handleFullFileChange` untuk handle upload masing-masing file
- [x] Update form validation: Tambahkan validasi untuk memastikan kedua file (preview dan full) sudah diupload sebelum submit
- [x] Update UI explanation: Ganti card "Commit-Reveal Process" menjadi "Preview-First System" dengan 3 steps yang sesuai product brief
- [x] Update submit handler: Implementasi upload 2 file ke storage (preview accessible, full locked) dan create submission dengan metadata
- [x] Update submit button: Disable jika file belum lengkap atau sedang uploading, show loading state
- [x] Update progress tracking: Tambahkan progress bars untuk preview dan full dataset upload
- [x] Update form fields: Pastikan form metadata (title, description, tags) terhubung dan dikirim bersama submission
- [x] Test UI flow: Upload preview → Upload full → Fill metadata → Submit → Verify navigation ke /my-submissions (Implementation complete, ready for manual testing)
- [x] Test validation: Verify submit button disabled jika file belum lengkap (Implementation complete, ready for manual testing)
- [x] Test error handling: Handle error cases (upload failed, network error, dll) (Error handling implemented, ready for manual testing)

## Acceptance Criteria

### Functional Requirements:

1. **Contributor dapat upload 2 file terpisah:**
   - Preview Dataset: Sample data representatif dari full dataset
   - Full Dataset: Data lengkap yang akan di-lock sampai approve
   - Kedua file harus diupload sebelum submit
   - File info (name, size) ditampilkan setelah upload

2. **Form validation bekerja dengan benar:**
   - Submit button disabled jika preview file belum diupload
   - Submit button disabled jika full file belum diupload
   - Submit button disabled jika sedang uploading
   - Error message ditampilkan jika submit tanpa file lengkap

3. **UI explanation sesuai product brief:**
   - Card "Preview-First System" menjelaskan 3 steps dengan benar
   - Penjelasan bahwa preview = sample data (bukan thumbnail/compressed)
   - Contoh yang jelas tentang preview vs full dataset

4. **Submit handler bekerja dengan benar:**
   - Upload preview dataset terlebih dahulu (accessible immediately)
   - Upload full dataset setelah preview (locked until approve)
   - Create submission dengan metadata yang benar
   - Navigate ke /my-submissions setelah berhasil

5. **Progress tracking:**
   - Progress bar untuk preview upload
   - Progress bar untuk full upload
   - Status indicator untuk current step

### UI/UX Requirements:

1. **Design consistency:**
   - Mengikuti design system yang sudah ada
   - Drag-drop areas menggunakan style yang konsisten
   - Form layout mengikuti pattern yang sudah ada

2. **User feedback:**
   - Clear error messages
   - Progress indicators
   - Loading states
   - Success feedback

3. **Responsive design:**
   - File upload sections responsive
   - Form layout responsive untuk mobile dan desktop

### Technical Requirements:

1. **Type safety:**
   - Semua state dan functions menggunakan TypeScript dengan proper types
   - File types validated

2. **Code organization:**
   - State management clear dan terorganisir
   - Upload functions terpisah dan reusable
   - Mock functions mudah diganti dengan real API calls nanti

3. **Error handling:**
   - Handle upload errors
   - Handle network errors
   - Handle validation errors
   - User-friendly error messages

